<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>페이지 3 - DataShare 테스트</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .nav {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
      }

      .nav a {
        display: inline-block;
        padding: 10px 20px;
        margin-right: 10px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        transition: background-color 0.3s;
      }

      .nav a:hover {
        background: #0056b3;
      }

      .nav a.current {
        background: #28a745;
      }

      .content {
        padding: 30px;
      }

      .section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
      }

      .section h2 {
        color: #495057;
        margin-bottom: 20px;
        font-size: 1.4rem;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-danger {
        background: linear-gradient(45deg, #f44336, #e91e63);
      }

      .btn-danger:hover {
        box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
      }

      .data-display {
        background: #f3f4ff;
        border: 2px solid #667eea;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
      }

      .data-display h3 {
        color: #4c63d2;
        margin-bottom: 10px;
      }

      .data-item {
        background: white;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        border-left: 4px solid #667eea;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .data-key {
        font-weight: bold;
        color: #4c63d2;
      }

      .data-value {
        color: #424242;
        margin-left: 10px;
      }

      .status {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #667eea;
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        z-index: 1000;
      }

      .info-box {
        background: #e7f3ff;
        border: 1px solid #b8daff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .info-box h3 {
        color: #004085;
        margin-bottom: 10px;
      }

      .info-box p {
        color: #004085;
        margin-bottom: 5px;
      }

      .watch-display {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
      }

      .watch-entry {
        background: white;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        border-left: 4px solid #ffc107;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .watch-time {
        color: #856404;
        font-weight: bold;
      }

      .watch-key {
        color: #d39e00;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="status" id="status">페이지 3 로딩 중...</div>

    <div class="container">
      <div class="header">
        <h1>👀 페이지 3</h1>
        <p>IndexedDB 기반 데이터 공유 테스트 - 실시간 감시 및 동기화</p>
      </div>

      <div class="nav">
        <a href="page1.html">페이지 1</a>
        <a href="page2.html">페이지 2</a>
        <a href="page3.html" class="current">페이지 3</a>
        <a href="dashboard.html">대시보드</a>
      </div>

      <div class="content">
        <div class="info-box">
          <h3>🎯 페이지 3의 역할</h3>
          <p>• 실시간 데이터 변경 감시 기능을 테스트합니다</p>
          <p>• 다른 페이지에서 변경된 데이터를 실시간으로 확인합니다</p>
          <p>• 패턴 매칭을 통한 선택적 감시를 지원합니다</p>
        </div>

        <div class="section">
          <h2>👁️ 데이터 감시 설정</h2>

          <div class="form-group">
            <label for="watchPattern">감시할 패턴</label>
            <input
              type="text"
              id="watchPattern"
              placeholder="예: user.*, app.*, *"
              value="*"
            />
          </div>

          <button class="btn" onclick="startWatching()">👁️ 감시 시작</button>
          <button class="btn btn-danger" onclick="stopWatching()">
            ❌ 감시 중지
          </button>
          <button class="btn" onclick="clearWatchLog()">🧹 로그 지우기</button>
        </div>

        <div class="section">
          <h2>📝 테스트 데이터 생성</h2>

          <div class="form-group">
            <label for="testKey">테스트 키</label>
            <input
              type="text"
              id="testKey"
              placeholder="예: test.data"
              value="test.data"
            />
          </div>

          <div class="form-group">
            <label for="testValue">테스트 값</label>
            <input
              type="text"
              id="testValue"
              placeholder="테스트할 값을 입력하세요"
            />
          </div>

          <button class="btn" onclick="createTestData()">
            📝 테스트 데이터 생성
          </button>
          <button class="btn" onclick="updateTestData()">
            🔄 테스트 데이터 업데이트
          </button>
          <button class="btn btn-danger" onclick="deleteTestData()">
            🗑️ 테스트 데이터 삭제
          </button>
        </div>

        <div class="section">
          <h2>🔄 자동 데이터 생성기</h2>

          <div class="form-group">
            <label for="autoInterval">생성 간격 (초)</label>
            <input type="number" id="autoInterval" value="3" min="1" max="60" />
          </div>

          <button class="btn" onclick="startAutoGeneration()">
            🚀 자동 생성 시작
          </button>
          <button class="btn btn-danger" onclick="stopAutoGeneration()">
            ⏹️ 자동 생성 중지
          </button>
        </div>

        <div class="watch-display">
          <h3>📡 실시간 데이터 변경 로그</h3>
          <div id="watchLog">
            <div class="watch-entry">
              <span class="watch-time">[시작]</span>
              <span>데이터 감시를 시작하세요.</span>
            </div>
          </div>
        </div>

        <div class="data-display">
          <h3>📊 현재 저장된 데이터</h3>
          <div id="currentData">데이터 로딩 중...</div>
        </div>
      </div>
    </div>

    <script src="DataSharePersistent.js"></script>
    <script>
      "use strict";

      let isInitialized = false;
      let watchUnsubscribe = null;
      let autoGenerationInterval = null;
      let watchLogCounter = 0;

      // 페이지 로드 시 초기화
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("🎯 [페이지 3] DOM 로딩 완료");

        try {
          // DataShare 초기화 대기
          await DataShare.init();

          console.log("✅ [페이지 3] DataShare 초기화 완료");
          DataShare.setDevMode(true);

          // 저장된 데이터 표시
          updateCurrentData();

          // 상태 업데이트
          updateStatus("페이지 3 준비됨", "success");

          isInitialized = true;
        } catch (error) {
          console.error("❌ [페이지 3] 초기화 실패:", error);
          updateStatus("초기화 실패", "error");
        }
      });

      /**
       * 데이터 감시 시작
       */
      function startWatching() {
        if (!isInitialized) {
          alert("아직 초기화가 완료되지 않았습니다.");
          return;
        }

        const pattern = document.getElementById("watchPattern").value.trim();

        if (!pattern) {
          alert("감시할 패턴을 입력해주세요.");
          return;
        }

        // 기존 감시 중지
        if (watchUnsubscribe) {
          watchUnsubscribe();
        }

        try {
          watchUnsubscribe = DataShare.watch(
            pattern,
            function (newValue, oldValue, key) {
              addWatchLog("CHANGE", `${key} 변경됨`, {
                key: key,
                old: oldValue,
                new: newValue,
              });

              // 현재 데이터 표시도 업데이트
              updateCurrentData();
            }
          );

          addWatchLog("SYSTEM", `감시 시작: ${pattern}`);
          updateStatus(`감시 중: ${pattern}`, "watching");

          console.log(`✅ [페이지 3] 데이터 감시 시작: ${pattern}`);
        } catch (error) {
          console.error("❌ [페이지 3] 감시 시작 실패:", error);
          updateStatus("감시 시작 실패", "error");
          alert("감시 시작에 실패했습니다: " + error.message);
        }
      }

      /**
       * 데이터 감시 중지
       */
      function stopWatching() {
        if (watchUnsubscribe) {
          watchUnsubscribe();
          watchUnsubscribe = null;

          addWatchLog("SYSTEM", "감시 중지됨");
          updateStatus("감시 중지됨", "success");

          console.log("✅ [페이지 3] 데이터 감시 중지");
        } else {
          addWatchLog("INFO", "활성화된 감시가 없습니다");
          updateStatus("감시 없음", "warning");
        }
      }

      /**
       * 테스트 데이터 생성
       */
      async function createTestData() {
        if (!isInitialized) {
          alert("아직 초기화가 완료되지 않았습니다.");
          return;
        }

        const key = document.getElementById("testKey").value.trim();
        const value = document.getElementById("testValue").value.trim();

        if (!key || !value) {
          alert("키와 값을 모두 입력해주세요.");
          return;
        }

        try {
          await DataShare.set(key, value);
          console.log(`✅ [페이지 3] 테스트 데이터 생성: ${key} = ${value}`);

          updateCurrentData();
          updateStatus("테스트 데이터 생성됨", "success");

          // 입력 필드 비우기
          document.getElementById("testValue").value = "";
        } catch (error) {
          console.error("❌ [페이지 3] 테스트 데이터 생성 실패:", error);
          updateStatus("생성 실패", "error");
        }
      }

      /**
       * 테스트 데이터 업데이트
       */
      async function updateTestData() {
        if (!isInitialized) {
          alert("아직 초기화가 완료되지 않았습니다.");
          return;
        }

        const key = document.getElementById("testKey").value.trim();
        const value =
          document.getElementById("testValue").value.trim() + " (업데이트됨)";

        if (!key) {
          alert("키를 입력해주세요.");
          return;
        }

        try {
          await DataShare.set(key, value);
          console.log(
            `✅ [페이지 3] 테스트 데이터 업데이트: ${key} = ${value}`
          );

          updateCurrentData();
          updateStatus("테스트 데이터 업데이트됨", "success");
        } catch (error) {
          console.error("❌ [페이지 3] 테스트 데이터 업데이트 실패:", error);
          updateStatus("업데이트 실패", "error");
        }
      }

      /**
       * 테스트 데이터 삭제
       */
      async function deleteTestData() {
        if (!isInitialized) {
          alert("아직 초기화가 완료되지 않았습니다.");
          return;
        }

        const key = document.getElementById("testKey").value.trim();

        if (!key) {
          alert("키를 입력해주세요.");
          return;
        }

        try {
          await DataShare.clear(key);
          console.log(`✅ [페이지 3] 테스트 데이터 삭제: ${key}`);

          updateCurrentData();
          updateStatus("테스트 데이터 삭제됨", "success");
        } catch (error) {
          console.error("❌ [페이지 3] 테스트 데이터 삭제 실패:", error);
          updateStatus("삭제 실패", "error");
        }
      }

      /**
       * 자동 데이터 생성 시작
       */
      function startAutoGeneration() {
        if (!isInitialized) {
          alert("아직 초기화가 완료되지 않았습니다.");
          return;
        }

        if (autoGenerationInterval) {
          alert("이미 자동 생성이 실행 중입니다.");
          return;
        }

        const interval =
          parseInt(document.getElementById("autoInterval").value) * 1000 ||
          3000;

        autoGenerationInterval = setInterval(async () => {
          const timestamp = new Date().toISOString();
          const randomValue = Math.floor(Math.random() * 1000);
          const key = `auto.data.${randomValue}`;
          const value = {
            timestamp: timestamp,
            randomValue: randomValue,
            message: `자동 생성된 데이터 #${randomValue}`,
          };

          try {
            await DataShare.set(key, value);
            console.log(`🤖 [페이지 3] 자동 데이터 생성: ${key}`);
          } catch (error) {
            console.error("❌ [페이지 3] 자동 데이터 생성 실패:", error);
          }
        }, interval);

        addWatchLog("SYSTEM", `자동 생성 시작 (${interval / 1000}초 간격)`);
        updateStatus(`자동 생성 중 (${interval / 1000}초)`, "success");

        console.log(`✅ [페이지 3] 자동 데이터 생성 시작: ${interval}ms 간격`);
      }

      /**
       * 자동 데이터 생성 중지
       */
      function stopAutoGeneration() {
        if (autoGenerationInterval) {
          clearInterval(autoGenerationInterval);
          autoGenerationInterval = null;

          addWatchLog("SYSTEM", "자동 생성 중지됨");
          updateStatus("자동 생성 중지됨", "success");

          console.log("✅ [페이지 3] 자동 데이터 생성 중지");
        } else {
          addWatchLog("INFO", "실행 중인 자동 생성이 없습니다");
          updateStatus("자동 생성 없음", "warning");
        }
      }

      /**
       * 감시 로그 추가
       */
      function addWatchLog(type, message, data = null) {
        const watchLogDiv = document.getElementById("watchLog");
        const time = new Date().toLocaleTimeString();
        watchLogCounter++;

        const logEntry = document.createElement("div");
        logEntry.className = "watch-entry";

        let logContent = `<span class="watch-time">[${time}]</span> <span class="watch-key">[${type}]</span> ${message}`;

        if (data) {
          logContent += `<br><small>데이터: ${JSON.stringify(
            data,
            null,
            2
          )}</small>`;
        }

        logEntry.innerHTML = logContent;

        watchLogDiv.insertBefore(logEntry, watchLogDiv.firstChild);

        // 로그가 너무 많아지면 오래된 것 제거
        if (watchLogDiv.children.length > 50) {
          watchLogDiv.removeChild(watchLogDiv.lastChild);
        }
      }

      /**
       * 감시 로그 지우기
       */
      function clearWatchLog() {
        const watchLogDiv = document.getElementById("watchLog");
        watchLogDiv.innerHTML =
          '<div class="watch-entry"><span class="watch-time">[지워짐]</span> 로그가 지워졌습니다.</div>';
        watchLogCounter = 0;
      }

      /**
       * 현재 데이터 표시 업데이트
       */
      function updateCurrentData() {
        const currentDataDiv = document.getElementById("currentData");

        if (!isInitialized) {
          currentDataDiv.innerHTML = "<em>초기화 중...</em>";
          return;
        }

        const allData = DataShare.getAll();
        const keys = Object.keys(allData);

        if (keys.length === 0) {
          currentDataDiv.innerHTML = "<em>저장된 데이터가 없습니다.</em>";
          return;
        }

        let html = "";
        keys.forEach((key) => {
          const value = allData[key];
          html += `
            <div class="data-item">
              <span class="data-key">${key}:</span>
              <span class="data-value">${JSON.stringify(value, null, 2)}</span>
            </div>
          `;
        });

        currentDataDiv.innerHTML = html;
      }

      /**
       * 상태 표시 업데이트
       */
      function updateStatus(message, type = "success") {
        const status = document.getElementById("status");
        status.textContent = message;

        const colors = {
          success: "#667eea",
          error: "#f44336",
          warning: "#ff9800",
          watching: "#28a745",
        };

        status.style.backgroundColor = colors[type] || colors.success;

        setTimeout(() => {
          status.textContent = "페이지 3 준비됨";
          status.style.backgroundColor = colors.success;
        }, 3000);
      }

      // 페이지 언로드 시 정리
      window.addEventListener("beforeunload", function () {
        console.log("🔄 [페이지 3] 페이지 언로드");

        // 감시 중지
        if (watchUnsubscribe) {
          watchUnsubscribe();
        }

        // 자동 생성 중지
        if (autoGenerationInterval) {
          clearInterval(autoGenerationInterval);
        }
      });
    </script>
  </body>
</html>
