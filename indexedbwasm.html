<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IndexedDB + WASM(HNSW) Vector Search Demo</title>
    <style>
      :root {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Noto Sans, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      }
      body {
        margin: 0;
        padding: 24px;
        background: #0b1020;
        color: #e7ecff;
      }
      h1 {
        margin: 0 0 12px;
        font-size: 20px;
      }
      .wrap {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 16px;
      }
      .card {
        background: #111737;
        border: 1px solid #273058;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      }
      textarea,
      input,
      select,
      button {
        width: 100%;
        box-sizing: border-box;
        background: #0c1230;
        color: #e7ecff;
        border: 1px solid #273058;
        border-radius: 12px;
        padding: 10px 12px;
      }
      textarea {
        min-height: 140px;
        resize: vertical;
      }
      button {
        cursor: pointer;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .muted {
        color: #a9b3d6;
        font-size: 12px;
      }
      .badge {
        display: inline-block;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #273058;
        background: #0f1636;
      }
      .result {
        padding: 12px;
        border: 1px dashed #33407a;
        border-radius: 12px;
        margin-bottom: 8px;
        background: #0f1430;
      }
      code {
        background: #0d1230;
        padding: 0 6px;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <h1>IndexedDB + WASM(HNSW) ë²¡í„° ê²€ìƒ‰ ë°ëª¨</h1>
    <p class="muted">
      ë¸Œë¼ìš°ì €ë§Œìœ¼ë¡œ ë²¡í„°ë¥¼ ì €ì¥/ì¸ë±ì‹±/ê²€ìƒ‰í•˜ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤.
      <span class="badge">IndexedDB</span>ì— ë¬¸ì„œì™€ ì„ë² ë”©ì„ ì €ì¥í•˜ê³ ,
      <span class="badge">HNSW (WASM)</span>ìœ¼ë¡œ ê·¼ì‚¬ ìµœê·¼ì ‘ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
      WASM ë¡œë”© ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ <b>ë¸Œë£¨íŠ¸í¬ìŠ¤ ì½”ì‚¬ì¸</b>ìœ¼ë¡œ í´ë°±í•©ë‹ˆë‹¤.
    </p>
    <div class="wrap">
      <div class="card">
        <h3>â‘  ë¬¸ì„œ ì¶”ê°€</h3>
        <textarea id="docsInput" placeholder="í•œ ì¤„ì— í•œ ë¬¸ì„œì”© ì…ë ¥í•˜ì„¸ìš”.">
ê³„ì•½ í•´ì§€ëŠ” ì„œë©´ í†µë³´ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.
ì„œë¹„ìŠ¤ í•´ì•½ ì ˆì°¨ëŠ” ë§ˆì´í˜ì´ì§€ì—ì„œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì •ê¸° êµ¬ë…ì„ ì¢…ë£Œí•˜ë ¤ë©´ ê²°ì œì¼ í•˜ë£¨ ì „ì— í•´ì§€ë¥¼ ìš”ì²­í•˜ì„¸ìš”.
í™˜ë¶ˆ ìš”ì²­ì€ ê²°ì œ í›„ 7ì¼ ì´ë‚´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
ì¹´ë“œì‚¬ ìŠ¹ì¸ ì·¨ì†ŒëŠ” ì˜ì—…ì¼ ê¸°ì¤€ 3ì¼ ê±¸ë¦½ë‹ˆë‹¤.
ë°°ì†¡ ì§€ì—° ì‹œ ì•Œë¦¼ ë¬¸ìê°€ ë°œì†¡ë©ë‹ˆë‹¤.
íƒë°° ë°°ì†¡ ì¡°íšŒëŠ” ìš´ì†¡ì¥ ë²ˆí˜¸ë¡œ í™•ì¸í•˜ì„¸ìš”.
ìš”ê¸ˆ ì²­êµ¬ì„œëŠ” ë§¤ì›” 1ì¼ ë°œí–‰ë©ë‹ˆë‹¤.
ìš”ê¸ˆì œë¥¼ ë³€ê²½í•˜ë©´ ë‹¤ìŒ ë‹¬ë¶€í„° ì ìš©ë©ë‹ˆë‹¤.
ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 10ì ì´ìƒìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.
ì´ìƒ ë¡œê·¸ì¸ ì‹œ ê³„ì •ì´ ì ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2ë‹¨ê³„ ì¸ì¦ì„ í™œì„±í™”í•˜ë©´ ë³´ì•ˆì´ ê°•í™”ë©ë‹ˆë‹¤.</textarea
        >
        <div class="row" style="margin-top: 8px">
          <select id="dimSel">
            <option value="256">ì°¨ì›: 256</option>
            <option value="384">ì°¨ì›: 384</option>
            <option value="512">ì°¨ì›: 512</option>
          </select>
          <select id="metricSel">
            <option value="cosine">ì½”ì‚¬ì¸</option>
            <option value="l2">L2 (ìœ í´ë¦¬ë“œ)</option>
            <option value="ip">Inner Product</option>
          </select>
        </div>
        <div class="row" style="margin-top: 8px">
          <button id="btnAddDocs">ë¬¸ì„œ ì¶”ê°€ & ì €ì¥</button>
          <button id="btnBuildIndex">HNSW ì¸ë±ìŠ¤ ë¹Œë“œ</button>
        </div>
        <p class="muted" id="statusText" style="margin-top: 8px">
          ìƒíƒœ: ì´ˆê¸°í™”
        </p>
        <details style="margin-top: 8px">
          <summary>ê³ ê¸‰ì„¤ì • (HNSW)</summary>
          <div class="row" style="margin-top: 8px">
            <input
              id="M"
              type="number"
              value="16"
              placeholder="M (ê·¸ë˜í”„ ì—°ê²°ë„)"
            />
            <input
              id="efC"
              type="number"
              value="100"
              placeholder="efConstruction"
            />
          </div>
          <div class="row" style="margin-top: 8px">
            <input id="efS" type="number" value="64" placeholder="efSearch" />
            <input
              id="maxEl"
              type="number"
              value="10000"
              placeholder="ìµœëŒ€ ìš”ì†Œ ìˆ˜"
            />
          </div>
        </details>
        <details style="margin-top: 8px">
          <summary>WASM ë¡œë”© ì˜µì…˜</summary>
          <p class="muted">
            ì•„ë˜ ê²½ë¡œë¥¼ ì ì ˆí•œ WASM ë²ˆë“¤ë¡œ ë°”ê¾¸ì„¸ìš”. hnswlib-wasm í˜¸í™˜ ESM
            ë²ˆë“¤ì„ ê°€ì •í•©ë‹ˆë‹¤.
          </p>
          <input id="wasmUrl" value="/hnswlib-wasm/hnswlib.js" />
          <button id="btnLoadWasm" style="margin-top: 8px">
            WASM ëª¨ë“ˆ ë¡œë“œ
          </button>
          <p class="muted" id="wasmStatus">WASM: ë¯¸ë¡œë”© (í´ë°±=ë¸Œë£¨íŠ¸í¬ìŠ¤)</p>
        </details>
      </div>

      <div class="card">
        <h3>â‘¡ ê²€ìƒ‰</h3>
        <input id="q" placeholder="ì˜ˆ) í•´ì•½ ì ˆì°¨ê°€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?" />
        <div class="row" style="margin-top: 8px">
          <input id="topK" type="number" value="5" />
          <button id="btnSearch">ê²€ìƒ‰</button>
        </div>
        <div class="row" style="margin-top: 8px">
          <label style="display: flex; align-items: center; gap: 8px">
            <input id="useWasm" type="checkbox" checked /> WASM(HNSW) ì‚¬ìš©
            (ë¯¸ë¡œë”© ì‹œ ìë™ í´ë°±)
          </label>
        </div>
        <p class="muted" id="latency"></p>
        <div id="results"></div>
      </div>
    </div>

    <script type="module">
      /*************************************************
       * 0) ê°„ë‹¨í•œ ìœ í‹¸
       *************************************************/
      const $ = (sel) => document.querySelector(sel);
      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

      // L2 normalize
      function l2normalize(vec) {
        let sum = 0.0;
        for (let i = 0; i < vec.length; i++) sum += vec[i] * vec[i];
        const n = Math.sqrt(sum) + 1e-8;
        for (let i = 0; i < vec.length; i++) vec[i] /= n;
        return vec;
      }

      function cosine(a, b) {
        let dot = 0,
          na = 0,
          nb = 0;
        for (let i = 0; i < a.length; i++) {
          const x = a[i],
            y = b[i];
          dot += x * y;
          na += x * x;
          nb += y * y;
        }
        return dot / (Math.sqrt(na) * Math.sqrt(nb) + 1e-8);
      }

      function l2(a, b) {
        let s = 0;
        for (let i = 0; i < a.length; i++) {
          const d = a[i] - b[i];
          s += d * d;
        }
        return Math.sqrt(s);
      }

      function inner(a, b) {
        let s = 0;
        for (let i = 0; i < a.length; i++) {
          s += a[i] * b[i];
        }
        return s;
      }

      /*************************************************
       * 1) IndexedDB ë˜í¼
       *************************************************/
      const DB_NAME = "vector-demo";
      const DB_VERSION = 1;
      const STORE_DOCS = "docs"; // {id, text, emb:ArrayBuffer(Float32)}
      const STORE_INDEX = "hnswIndex"; // serialized index blob

      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onupgradeneeded = (e) => {
            const db = req.result;
            if (!db.objectStoreNames.contains(STORE_DOCS)) {
              const os = db.createObjectStore(STORE_DOCS, { keyPath: "id" });
              os.createIndex("by_id", "id", { unique: true });
            }
            if (!db.objectStoreNames.contains(STORE_INDEX)) {
              db.createObjectStore(STORE_INDEX, { keyPath: "key" });
            }
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }

      async function putDocs(db, docs) {
        return new Promise((resolve, reject) => {
          const tx = db.transaction([STORE_DOCS], "readwrite");
          const os = tx.objectStore(STORE_DOCS);
          docs.forEach((d) => os.put(d));
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      }

      async function getAllDocs(db) {
        return new Promise((resolve, reject) => {
          const tx = db.transaction([STORE_DOCS], "readonly");
          const os = tx.objectStore(STORE_DOCS);
          const req = os.getAll();
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }

      async function saveIndex(db, key, buf) {
        return new Promise((resolve, reject) => {
          const tx = db.transaction([STORE_INDEX], "readwrite");
          tx.objectStore(STORE_INDEX).put({ key, buf });
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      }

      async function loadIndex(db, key) {
        return new Promise((resolve, reject) => {
          const tx = db.transaction([STORE_INDEX], "readonly");
          const req = tx.objectStore(STORE_INDEX).get(key);
          req.onsuccess = () => resolve(req.result?.buf || null);
          req.onerror = () => reject(req.error);
        });
      }

      /*************************************************
       * 2) í† ì´ ì„ë² ë”© í•¨ìˆ˜ (ë°ëª¨ìš©)
       * - í•´ì‹œ íŠ¸ë¦­ ê¸°ë°˜ 1-3gram bag â†’ dim ì°¨ì› float32
       * - ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì„œë²„ì—ì„œ ì„ë² ë”© ê³„ì‚° ê¶Œì¥
       *************************************************/
      function hashStr(str) {
        // FNV-1a
        let h = 2166136261 >>> 0;
        for (let i = 0; i < str.length; i++) {
          h ^= str.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return h >>> 0;
      }

      function embed(text, dim = 256) {
        const v = new Float32Array(dim);
        const s = text.toLowerCase();
        const grams = new Set();
        for (let n = 1; n <= 3; n++) {
          for (let i = 0; i <= s.length - n; i++) grams.add(s.slice(i, i + n));
        }
        grams.forEach((g) => {
          const idx = hashStr(g) % dim;
          v[idx] += 1.0;
        });
        return l2normalize(v);
      }

      /*************************************************
       * 3) HNSW WASM ì–´ëŒ‘í„° (ë™ì  ë¡œë“œ)
       * - hnswlib-wasm í˜¸í™˜ API ê°€ì •
       * - ì‹¤íŒ¨ ì‹œ null ë°˜í™˜ â†’ ë¸Œë£¨íŠ¸í¬ìŠ¤ ì‚¬ìš©
       *************************************************/
      let HNSW = null; // { init, addPoint, searchKnn, serialize, deserialize }

      async function loadHNSW(url) {
        try {
          const mod = await import(url);
          if (!mod || !mod.default) return null;
          const api = await mod.default();
          return api; // êµ¬í˜„ì²´ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ì‚¬ìš©ì²˜ì—ì„œ ê°€ë“œ
        } catch (e) {
          console.warn("WASM load failed:", e);
          return null;
        }
      }

      /*************************************************
       * 4) ìƒíƒœ ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
       *************************************************/
      const db = await openDB();
      $("#statusText").textContent = "ìƒíƒœ: DB ì˜¤í”ˆ ì™„ë£Œ";

      let DIM = parseInt($("#dimSel").value, 10);
      let METRIC = $("#metricSel").value; // 'cosine' | 'l2' | 'ip'

      $("#dimSel").addEventListener(
        "change",
        (e) => (DIM = parseInt(e.target.value, 10))
      );
      $("#metricSel").addEventListener(
        "change",
        (e) => (METRIC = e.target.value)
      );

      $("#btnLoadWasm").addEventListener("click", async () => {
        const url = $("#wasmUrl").value.trim();
        $("#wasmStatus").textContent = "WASM: ë¡œë”© ì¤‘...";
        HNSW = await loadHNSW(url);
        $("#wasmStatus").textContent = HNSW
          ? "WASM: ë¡œë”© ì™„ë£Œ âœ…"
          : "WASM: ë¡œë”© ì‹¤íŒ¨ â†’ í´ë°± ì‚¬ìš©";
      });

      // ë¬¸ì„œ ì¶”ê°€ & ì €ì¥
      $("#btnAddDocs").addEventListener("click", async () => {
        const lines = $("#docsInput")
          .value.split(/\n+/)
          .map((s) => s.trim())
          .filter(Boolean);
        const docs = lines.map((text, i) => {
          const id = "doc_" + Math.random().toString(36).slice(2, 10);
          const emb = embed(text, DIM);
          return { id, text, emb: emb.buffer };
        });
        await putDocs(db, docs);
        $(
          "#statusText"
        ).textContent = `ìƒíƒœ: ë¬¸ì„œ ${docs.length}ê±´ ì €ì¥ (ì°¨ì›=${DIM})`;
      });

      // ì¸ë±ìŠ¤ ë¹Œë“œ (WASM ìˆìœ¼ë©´ HNSWë¡œ, ì—†ìœ¼ë©´ ì €ì¥ë§Œ)
      $("#btnBuildIndex").addEventListener("click", async () => {
        const M = parseInt($("#M").value, 10);
        const efConstruction = parseInt($("#efC").value, 10);
        const maxElements = parseInt($("#maxEl").value, 10);

        const all = await getAllDocs(db);
        if (!all.length) {
          alert("ë¨¼ì € ë¬¸ì„œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.");
          return;
        }

        const start = performance.now();

        if (HNSW && HNSW.createIndex) {
          // ê°€ìƒì˜ hnswlib-wasm í˜¸í™˜ API ì˜ˆì‹œ
          const index = HNSW.createIndex({
            dim: DIM,
            space: METRIC,
            maxElements,
            M,
            efConstruction,
          });
          for (const d of all) {
            index.addPoint(new Float32Array(d.emb), d.id);
          }
          index.setEf(parseInt($("#efS").value, 10));
          const buf = index.serialize();
          await saveIndex(db, `hnsw_${DIM}_${METRIC}`, buf);
          $("#statusText").textContent = `ìƒíƒœ: HNSW ì¸ë±ìŠ¤ ë¹Œë“œ/ì €ì¥ ì™„ë£Œ (${(
            performance.now() - start
          ).toFixed(1)} ms)`;
        } else {
          // í´ë°±: ë¸Œë£¨íŠ¸í¬ìŠ¤ë§Œ ì‚¬ìš©í•  ì˜ˆì • â†’ ë¬¸ì„œë§Œ ìˆìœ¼ë©´ ë¨
          await saveIndex(db, `hnsw_${DIM}_${METRIC}`, new ArrayBuffer(0));
          $("#statusText").textContent = `ìƒíƒœ: WASM ì—†ìŒ â†’ í´ë°± ëª¨ë“œ ì„¤ì • (${(
            performance.now() - start
          ).toFixed(1)} ms)`;
        }
      });

      // ê²€ìƒ‰
      $("#btnSearch").addEventListener("click", async () => {
        const q = $("#q").value.trim();
        if (!q) return;
        const topK = parseInt($("#topK").value, 10) || 5;
        const useWasm = $("#useWasm").checked && HNSW;
        const qv = embed(q, DIM);

        const all = await getAllDocs(db);
        if (!all.length) {
          alert("ë¬¸ì„œë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”.");
          return;
        }

        const t0 = performance.now();

        let results = [];
        if (useWasm && HNSW && HNSW.createIndex) {
          const buf = await loadIndex(db, `hnsw_${DIM}_${METRIC}`);
          if (!buf) {
            alert("HNSW ì¸ë±ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¹Œë“œí•˜ì„¸ìš”.");
            return;
          }
          const index = HNSW.deserialize(buf);
          index.setEf(parseInt($("#efS").value, 10));
          const out = index.searchKnn(qv, topK); // { labels:[], distances:[] }
          const byId = new Map(all.map((d) => [d.id, d]));
          for (let i = 0; i < out.labels.length; i++) {
            const id = out.labels[i];
            const dist = out.distances[i];
            results.push({
              id,
              score: metricToScore(METRIC, dist),
              text: byId.get(id)?.text || "",
            });
          }
        } else {
          // í´ë°±: ì „ìˆ˜ ì½”ì‚¬ì¸/ë‚´ì /L2
          const metric = METRIC;
          const scorer = (a, b) =>
            metric === "cosine"
              ? cosine(a, b)
              : metric === "ip"
              ? inner(a, b)
              : -l2(a, b);
          const arr = [];
          for (const d of all) {
            const score = scorer(qv, new Float32Array(d.emb));
            arr.push({ id: d.id, text: d.text, score });
          }
          arr.sort((a, b) => b.score - a.score);
          results = arr.slice(0, topK);
        }

        const elapsed = performance.now() - t0;
        $("#latency").textContent = `ê²€ìƒ‰ ì§€ì—°: ${elapsed.toFixed(1)} ms (${
          useWasm ? "HNSW/WASM" : "í´ë°±(ë¸Œë£¨íŠ¸í¬ìŠ¤)"
        })`;
        renderResults(results);
      });

      function metricToScore(metric, dist) {
        // HNSW êµ¬í˜„ì²´ë³„ë¡œ distance ì˜ë¯¸ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ ê°€ë³€ ì²˜ë¦¬
        if (metric === "cosine") return 1.0 - dist; // ë³´í†µ ì½”ì‚¬ì¸ ê±°ë¦¬ë¥¼ ì“°ëŠ” ê²½ìš°
        if (metric === "l2") return -dist;
        return -dist; // ipëŠ” êµ¬í˜„ì²´ê°€ -dotì„ ê±°ë¦¬ë¡œ ë°˜í™˜í•˜ëŠ” ê²½ìš°ê°€ ìˆìŒ
      }

      function renderResults(items) {
        const root = $("#results");
        root.innerHTML = "";
        for (const r of items) {
          const el = document.createElement("div");
          el.className = "result";
          el.innerHTML = `<div class="muted">ID: <code>${
            r.id
          }</code> Â· score: <b>${r.score.toFixed(4)}</b></div>
                        <div style="margin-top:6px;">${escapeHtml(
                          r.text
                        )}</div>`;
          root.appendChild(el);
        }
      }

      function escapeHtml(s) {
        return s.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
    </script>

    <!--
    ğŸ“¦ ì‹¤ì œ WASM ë°”ì¸ë”©ì— ëŒ€í•´
    - ìœ„ì—ì„œ wasmUrl ì…ë ¥ë€ì— hnswlib-wasm í˜¸í™˜ ESM ë²ˆë“¤ì˜ ê²½ë¡œë¥¼ ë„£ìœ¼ì„¸ìš”.
    - ì˜ˆì‹œ APIë¥¼ ê°€ì •í–ˆìŠµë‹ˆë‹¤(createIndex/deserialize/searchKnn/serialize ë“±). ì‚¬ìš©í•˜ëŠ” ë²ˆë“¤ì— ë§ì¶° í•¨ìˆ˜ëª…ì„ ë§ì¶”ì„¸ìš”.
    - WASM ë¡œë”©ì´ ì‹¤íŒ¨í•˜ë©´ ìë™ìœ¼ë¡œ ë¸Œë£¨íŠ¸í¬ìŠ¤(ì „ìˆ˜)ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤. ì†Œê·œëª¨(â‰¤10k)ì—ì„œëŠ” ì´ê²ƒë§Œìœ¼ë¡œë„ ì¶©ë¶„íˆ ë¹ ë¦…ë‹ˆë‹¤.

    ğŸ§  ì‹¤ì œ ì„œë¹„ìŠ¤ ê¶Œì¥
    - ë¬¸ì„œ ì„ë² ë”©ì€ ì„œë²„ì—ì„œ ê³„ì‚° í›„ ë¸Œë¼ìš°ì €ë¡œ ì „ë‹¬(ì´ ë°ëª¨ëŠ” í•´ì‹œ íŠ¸ë¦­ ê¸°ë°˜ í† ì´ ì„ë² ë”©)
    - ëŒ€ê·œëª¨(>50k)ë¶€í„°ëŠ” ì„œë²„/ì—£ì§€ì˜ ë²¡í„°DB(ì˜ˆ: Qdrant/Milvus/Pinecone/pgvector) + ANN ê¶Œì¥
  --></body>
</html>
