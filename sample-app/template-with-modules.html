<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Template with Modules</title>
  </head>
  <body>
    <h1>모듈 기반 템플릿</h1>
    <p>이 템플릿은 주입된 모듈을 사용합니다</p>

    <div id="user-info">
      <h3>사용자 정보</h3>
      <p>로딩 중...</p>
    </div>

    <button id="refresh-user">사용자 정보 새로고침</button>
    <button id="show-modules">주입된 모듈 확인</button>

    <div id="module-info"></div>

    <script>
      (function () {
        "use strict";

        console.log("모듈 기반 템플릿 로드됨");
        console.log("컴포넌트 데이터:", window.componentData);

        // 주입된 모듈들 가져오기
        const { modules, $modules } = window.componentData;
        const api = modules.api || $modules.api;

        // 사용자 정보 로드 함수
        const loadUserInfo = async () => {
          const userInfoDiv = document.querySelector("#user-info");

          if (!api || typeof api.getUser !== "function") {
            userInfoDiv.innerHTML =
              '<p style="color: red;">API 모듈을 사용할 수 없습니다.</p>';
            return;
          }

          try {
            userInfoDiv.innerHTML = "<p>로딩 중...</p>";
            const userData = await api.getUser();
            console.log("템플릿에서 API 호출 결과:", userData);

            userInfoDiv.innerHTML = `
              <h3>사용자 정보</h3>
              <p><strong>이름:</strong> ${userData.name}</p>
              <p><strong>나이:</strong> ${userData.age}</p>
              <p><strong>이메일:</strong> ${userData.email}</p>
              <p><small>마지막 업데이트: ${new Date().toLocaleTimeString()}</small></p>
            `;
          } catch (error) {
            console.error("API 호출 실패:", error);
            userInfoDiv.innerHTML = `<p style="color: red;">API 호출 실패: ${error.message}</p>`;
          }
        };

        // 초기 로드
        loadUserInfo();

        // 새로고침 버튼 이벤트
        document
          .querySelector("#refresh-user")
          .addEventListener("click", loadUserInfo);

        // 모듈 정보 표시 버튼 이벤트
        document
          .querySelector("#show-modules")
          .addEventListener("click", () => {
            const moduleInfoDiv = document.querySelector("#module-info");
            const moduleNames = Object.keys($modules);

            moduleInfoDiv.innerHTML = `
            <h3>주입된 모듈들</h3>
            <ul>
              ${moduleNames
                .map(
                  (name) =>
                    `<li><strong>${name}</strong>: ${typeof $modules[
                      name
                    ]}</li>`
                )
                .join("")}
            </ul>
            <p>직접 주입된 모듈: ${
              Object.keys(modules).join(", ") || "없음"
            }</p>
          `;
          });

        // 전달받은 데이터 표시
        const dataInfo = document.createElement("div");
        dataInfo.innerHTML = `
          <h3>전달받은 데이터</h3>
          <p><strong>이름:</strong> ${window.componentData.name}</p>
          <p><strong>나이:</strong> ${window.componentData.age}</p>
          <p><strong>이메일:</strong> ${window.componentData.email}</p>
          <p><strong>타임스탬프:</strong> ${window.componentData.timestamp}</p>
        `;
        document.body.appendChild(dataInfo);
      })();
    </script>
  </body>
</html>
