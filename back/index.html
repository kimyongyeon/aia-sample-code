<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HistoryState í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .content {
        padding: 30px;
        min-height: 400px;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      .nav-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .product-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        transition: transform 0.3s ease;
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .product-image {
        width: 100px;
        height: 100px;
        background: #f8f9fa;
        border-radius: 50%;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }

      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        max-width: 400px;
        text-align: center;
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .popup-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .popup-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
      }

      .popup-message {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.5;
      }

      .popup-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .status-bar {
        background: #f8f9fa;
        padding: 10px 20px;
        border-top: 1px solid #dee2e6;
        font-size: 12px;
        color: #666;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ›’ ì‡¼í•‘ëª° íˆìŠ¤í† ë¦¬ í…ŒìŠ¤íŠ¸</h1>
        <p>ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>
      </div>

      <!-- í™ˆ í˜ì´ì§€ -->
      <div id="home-page" class="page active">
        <div class="content">
          <h2>ğŸ  í™ˆí˜ì´ì§€</h2>
          <p>í™˜ì˜í•©ë‹ˆë‹¤! ì´ í˜ì´ì§€ì—ì„œ ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <p>
            ë¸Œë¼ìš°ì €ì˜ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì‹œë©´ ë‹¨ê³„ë³„ë¡œ ë‹¤ë¥¸ íŒì—…ì´
            ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
          </p>

          <div class="nav-buttons">
            <button class="btn btn-primary" onclick="goToProductList()">
              ğŸ“‹ ìƒí’ˆ ëª©ë¡ ë³´ê¸°
            </button>
          </div>
        </div>
      </div>

      <!-- ìƒí’ˆ ëª©ë¡ í˜ì´ì§€ -->
      <div id="product-list-page" class="page">
        <div class="content">
          <h2>ğŸ“‹ ìƒí’ˆ ëª©ë¡</h2>
          <p>
            ë‹¤ì–‘í•œ ìƒí’ˆë“¤ì„ í™•ì¸í•´ë³´ì„¸ìš”. ìƒí’ˆì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ë¥¼ ë³¼ ìˆ˜
            ìˆìŠµë‹ˆë‹¤.
          </p>

          <div class="product-grid">
            <div class="product-card" onclick="goToProductDetail(1)">
              <div class="product-image">ğŸ“±</div>
              <h3>ìŠ¤ë§ˆíŠ¸í°</h3>
              <p>â‚©500,000</p>
            </div>
            <div class="product-card" onclick="goToProductDetail(2)">
              <div class="product-image">ğŸ’»</div>
              <h3>ë…¸íŠ¸ë¶</h3>
              <p>â‚©1,200,000</p>
            </div>
            <div class="product-card" onclick="goToProductDetail(3)">
              <div class="product-image">âŒš</div>
              <h3>ìŠ¤ë§ˆíŠ¸ì›Œì¹˜</h3>
              <p>â‚©300,000</p>
            </div>
          </div>

          <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="goToHome()">
              ğŸ  í™ˆìœ¼ë¡œ
            </button>
          </div>
        </div>
      </div>

      <!-- ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ -->
      <div id="product-detail-page" class="page">
        <div class="content">
          <h2>ğŸ“± ìƒí’ˆ ìƒì„¸</h2>
          <div id="product-detail-content">
            <div
              class="product-image"
              style="width: 150px; height: 150px; margin: 20px auto"
            >
              ğŸ“±
            </div>
            <h3 id="product-title">ìŠ¤ë§ˆíŠ¸í°</h3>
            <p id="product-price">â‚©500,000</p>
            <p id="product-description">
              ìµœì‹  ê¸°ìˆ ì´ ì ìš©ëœ ìŠ¤ë§ˆíŠ¸í°ì…ë‹ˆë‹¤. ê³ ì„±ëŠ¥ ì¹´ë©”ë¼ì™€ ê¸´ ë°°í„°ë¦¬
              ìˆ˜ëª…ì„ ìë‘í•©ë‹ˆë‹¤.
            </p>
          </div>

          <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="goToProductList()">
              ğŸ“‹ ëª©ë¡ìœ¼ë¡œ
            </button>
            <button class="btn btn-primary" onclick="addToCart()">
              ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
            </button>
          </div>
        </div>
      </div>

      <div class="status-bar">
        í˜„ì¬ ë‹¨ê³„: <span id="current-step">0</span> | íˆìŠ¤í† ë¦¬ ê¸¸ì´:
        <span id="history-length">1</span>
      </div>
    </div>

    <!-- íŒì—… ì˜¤ë²„ë ˆì´ -->
    <div id="overlay" class="overlay"></div>

    <!-- ì²« ë²ˆì§¸ ê²½ê³  íŒì—… -->
    <div id="warning-popup" class="popup">
      <div class="popup-icon">âš ï¸</div>
      <div class="popup-title">ì €ì¥ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­</div>
      <div class="popup-message">
        ì €ì¥ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
      </div>
      <div class="popup-buttons">
        <button class="btn btn-secondary" onclick="cancelNavigation()">
          ì·¨ì†Œ
        </button>
        <button class="btn btn-primary" onclick="continueNavigation()">
          ê³„ì†
        </button>
      </div>
    </div>

    <!-- ë‘ ë²ˆì§¸ ê²½ê³  íŒì—… -->
    <div id="confirm-popup" class="popup">
      <div class="popup-icon">â“</div>
      <div class="popup-title">í˜ì´ì§€ë¥¼ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</div>
      <div class="popup-message">
        ì •ë§ë¡œ ì´ í˜ì´ì§€ë¥¼ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì…ë ¥í•œ ì •ë³´ê°€ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜
        ìˆìŠµë‹ˆë‹¤.
      </div>
      <div class="popup-buttons">
        <button class="btn btn-secondary" onclick="cancelNavigation()">
          ì·¨ì†Œ
        </button>
        <button class="btn btn-primary" onclick="continueNavigation()">
          ë‚˜ê°€ê¸°
        </button>
      </div>
    </div>

    <!-- ìµœì¢… í™•ì¸ íŒì—… -->
    <div id="final-popup" class="popup">
      <div class="popup-icon">ğŸšª</div>
      <div class="popup-title">í˜ì´ì§€ë¥¼ ì™„ì „íˆ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
      <div class="popup-message">
        ì´ í˜ì´ì§€ë¥¼ ì™„ì „íˆ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
      </div>
      <div class="popup-buttons">
        <button class="btn btn-secondary" onclick="cancelNavigation()">
          ì·¨ì†Œ
        </button>
        <button class="btn btn-danger" onclick="finalExit()">ì¢…ë£Œ</button>
      </div>
    </div>

    <script src="historyUtil.js"></script>
    <script>
      "use strict";

      let currentStep = 0;
      let currentPage = "home";
      let navigationCallback = null;

      // HistoryStateManager ì´ˆê¸°í™”
      HistoryStateManager.init();

      // ì´ˆê¸° ìƒíƒœ ì„¤ì •
      HistoryStateManager.replaceState({
        step: 0,
        page: "home",
        title: "í™ˆí˜ì´ì§€",
      });

      // ë’¤ë¡œê°€ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬
      HistoryStateManager.onPopState((state) => {
        if (!state) return;

        console.log("PopState ë°œìƒ:", state);

        const step = state.step || 0;
        const page = state.page || "home";

        // ë‹¨ê³„ë³„ íŒì—… í‘œì‹œ
        if (step === 2) {
          // ìƒí’ˆ ìƒì„¸ -> ìƒí’ˆ ëª©ë¡: ì²« ë²ˆì§¸ ê²½ê³ 
          showWarningPopup();
        } else if (step === 1) {
          // ìƒí’ˆ ëª©ë¡ -> í™ˆ: ë‘ ë²ˆì§¸ ê²½ê³ 
          showConfirmPopup();
        } else if (step === 0) {
          // í™ˆ -> ì´ì „: ìµœì¢… í™•ì¸
          showFinalPopup();
        }
      });

      // í˜ì´ì§€ ì´ë™ í•¨ìˆ˜ë“¤
      function goToHome() {
        currentStep = 0;
        currentPage = "home";
        showPage("home-page");
        HistoryStateManager.pushState({
          step: 0,
          page: "home",
          title: "í™ˆí˜ì´ì§€",
        });
        updateStatus();
      }

      function goToProductList() {
        currentStep = 1;
        currentPage = "product-list";
        showPage("product-list-page");
        HistoryStateManager.pushState({
          step: 1,
          page: "product-list",
          title: "ìƒí’ˆ ëª©ë¡",
        });
        updateStatus();
      }

      function goToProductDetail(productId) {
        currentStep = 2;
        currentPage = "product-detail";
        showPage("product-detail-page");

        // ìƒí’ˆ ì •ë³´ ì„¤ì •
        const products = {
          1: {
            title: "ìŠ¤ë§ˆíŠ¸í°",
            price: "â‚©500,000",
            description:
              "ìµœì‹  ê¸°ìˆ ì´ ì ìš©ëœ ìŠ¤ë§ˆíŠ¸í°ì…ë‹ˆë‹¤. ê³ ì„±ëŠ¥ ì¹´ë©”ë¼ì™€ ê¸´ ë°°í„°ë¦¬ ìˆ˜ëª…ì„ ìë‘í•©ë‹ˆë‹¤.",
          },
          2: {
            title: "ë…¸íŠ¸ë¶",
            price: "â‚©1,200,000",
            description:
              "ì—…ë¬´ì™€ ê²Œì„ì— ìµœì í™”ëœ ê³ ì„±ëŠ¥ ë…¸íŠ¸ë¶ì…ë‹ˆë‹¤. ë¹ ë¥¸ ì²˜ë¦¬ ì†ë„ì™€ ë„‰ë„‰í•œ ì €ì¥ê³µê°„ì„ ì œê³µí•©ë‹ˆë‹¤.",
          },
          3: {
            title: "ìŠ¤ë§ˆíŠ¸ì›Œì¹˜",
            price: "â‚©300,000",
            description:
              "ê±´ê°• ê´€ë¦¬ì™€ ì•Œë¦¼ ê¸°ëŠ¥ì´ íƒ‘ì¬ëœ ìŠ¤ë§ˆíŠ¸ì›Œì¹˜ì…ë‹ˆë‹¤. 24ì‹œê°„ ì°©ìš© ê°€ëŠ¥í•œ í¸ì•ˆí•œ ë””ìì¸ì…ë‹ˆë‹¤.",
          },
        };

        const product = products[productId];
        document.getElementById("product-title").textContent = product.title;
        document.getElementById("product-price").textContent = product.price;
        document.getElementById("product-description").textContent =
          product.description;

        HistoryStateManager.pushState({
          step: 2,
          page: "product-detail",
          title: product.title,
          productId: productId,
        });
        updateStatus();
      }

      function addToCart() {
        alert("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
      }

      // í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜
      function showPage(pageId) {
        // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
        document.querySelectorAll(".page").forEach((page) => {
          page.classList.remove("active");
        });

        // í•´ë‹¹ í˜ì´ì§€ë§Œ í‘œì‹œ
        document.getElementById(pageId).classList.add("active");
      }

      // íŒì—… í‘œì‹œ í•¨ìˆ˜ë“¤
      function showWarningPopup() {
        navigationCallback = {
          onConfirm: () => {
            // ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ ì´ë™
            currentStep = 1;
            currentPage = "product-list";
            showPage("product-list-page");
            updateStatus();
          },
          onCancel: () => {
            // í˜„ì¬ ìƒíƒœ ìœ ì§€
            HistoryStateManager.pushState({
              step: 2,
              page: "product-detail",
              title: "ìƒí’ˆ ìƒì„¸",
            });
          },
        };

        document.getElementById("overlay").style.display = "block";
        document.getElementById("warning-popup").style.display = "block";
      }

      function showConfirmPopup() {
        navigationCallback = {
          onConfirm: () => {
            // í™ˆìœ¼ë¡œ ì´ë™
            currentStep = 0;
            currentPage = "home";
            showPage("home-page");
            updateStatus();
          },
          onCancel: () => {
            // í˜„ì¬ ìƒíƒœ ìœ ì§€
            HistoryStateManager.pushState({
              step: 1,
              page: "product-list",
              title: "ìƒí’ˆ ëª©ë¡",
            });
          },
        };

        document.getElementById("overlay").style.display = "block";
        document.getElementById("confirm-popup").style.display = "block";
      }

      function showFinalPopup() {
        navigationCallback = {
          onConfirm: () => {
            // ì‹¤ì œë¡œëŠ” ì´ì „ í˜ì´ì§€ë¡œ ì´ë™í•˜ê±°ë‚˜ ì•± ì¢…ë£Œ
            alert("í˜ì´ì§€ê°€ ì¢…ë£Œë©ë‹ˆë‹¤!");
            // ì—¬ê¸°ì„œëŠ” í™ˆí˜ì´ì§€ë¡œ ë¦¬ì…‹
            goToHome();
          },
          onCancel: () => {
            // í˜„ì¬ ìƒíƒœ ìœ ì§€
            HistoryStateManager.pushState({
              step: 0,
              page: "home",
              title: "í™ˆí˜ì´ì§€",
            });
          },
        };

        document.getElementById("overlay").style.display = "block";
        document.getElementById("final-popup").style.display = "block";
      }

      // íŒì—… ì•¡ì…˜ í•¨ìˆ˜ë“¤
      function continueNavigation() {
        hideAllPopups();
        if (navigationCallback && navigationCallback.onConfirm) {
          navigationCallback.onConfirm();
        }
      }

      function cancelNavigation() {
        hideAllPopups();
        if (navigationCallback && navigationCallback.onCancel) {
          navigationCallback.onCancel();
        }
      }

      function finalExit() {
        hideAllPopups();
        if (navigationCallback && navigationCallback.onConfirm) {
          navigationCallback.onConfirm();
        }
      }

      function hideAllPopups() {
        document.getElementById("overlay").style.display = "none";
        document.querySelectorAll(".popup").forEach((popup) => {
          popup.style.display = "none";
        });
      }

      // ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateStatus() {
        document.getElementById("current-step").textContent = currentStep;
        document.getElementById("history-length").textContent = history.length;
      }

      // ì´ˆê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
      updateStatus();
    </script>
  </body>
</html>
